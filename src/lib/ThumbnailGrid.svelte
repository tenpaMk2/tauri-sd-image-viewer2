<script lang="ts">
	import ImageThumbnail from './ImageThumbnail.svelte';
	import { ThumbnailService } from './services/thumbnail-service';
	import { globalThumbnailService } from './services/global-thumbnail-service';
	import { filterStore } from './stores/filter-store.svelte';
	import { TagAggregationService } from './services/tag-aggregation-service';
	import type { TagAggregationResult } from './services/tag-aggregation-service';

	const {
		directoryPath,
		onImageSelect,
		selectedImages = new Set(),
		onToggleSelection,
		refreshTrigger = 0,
		onImageFilesLoaded,
		onFilteredImagesUpdate,
		onTagDataLoaded
	}: {
		directoryPath: string;
		onImageSelect: (imagePath: string) => void;
		selectedImages?: Set<string>;
		onToggleSelection?: (imagePath: string, shiftKey?: boolean, metaKey?: boolean) => void;
		refreshTrigger?: number;
		onImageFilesLoaded?: (files: string[]) => void;
		onFilteredImagesUpdate?: (filteredCount: number, totalCount: number) => void;
		onTagDataLoaded?: (tagData: TagAggregationResult) => void;
	} = $props();

	// „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã„ÇíÁµ±Âêà
	type LoadingState = {
		isLoading: boolean;
		isProcessing: boolean;
		error: string;
		loadedCount: number;
		totalCount: number;
	};

	// „Çµ„Éº„Éì„Çπ„Ç§„É≥„Çπ„Çø„É≥„Çπ
	const thumbnailService = new ThumbnailService();
	const tagAggregationService = new TagAggregationService(thumbnailService);

	let imageFiles = $state<string[]>([]);
	let filteredImageFiles = $state<string[]>([]);
	let thumbnails = $state<Map<string, string>>(new Map());
	let ratings = $state<Map<string, number | undefined>>(new Map()); // „É¨„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≠„É£„ÉÉ„Ç∑„É•
	let loadingState = $state<LoadingState>({
		isLoading: true,
		isProcessing: false,
		error: '',
		loadedCount: 0,
		totalCount: 0
	});
	let lastRefreshTrigger = $state<number>(0);
	let ratingUpdateTrigger = $state<number>(0); // RatingÊõ¥Êñ∞„Çí„Éà„É™„Ç¨„Éº„Åô„Çã„Åü„ÇÅ„ÅÆstate

	// „É¨„Éº„ÉÜ„Ç£„É≥„Ç∞Ë™≠„ÅøËæº„ÅøÈñ¢Êï∞
	const loadRatings = async (imagePaths: string[]) => {
		const newRatings = new Map(ratings);
		for (const imagePath of imagePaths) {
			try {
				const rating = await thumbnailService.getImageRating(imagePath);
				newRatings.set(imagePath, rating);
			} catch (error) {
				console.warn('„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞ÂèñÂæóÂ§±Êïó:', imagePath, error);
				newRatings.set(imagePath, undefined);
			}
		}
		ratings = newRatings;
	};

	// „Çµ„É†„Éç„Ç§„É´Êï∞„ÅÆÂ§âÂåñ„Çí„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
	$effect(() => {
		console.log('=== „Çµ„É†„Éç„Ç§„É´Á∑èÊï∞Â§âÂåñ ===', thumbnails.size, '/', imageFiles.length);
		console.log(
			'Ë°®Á§∫ÂèØËÉΩ„Å™„Çµ„É†„Éç„Ç§„É´:',
			Array.from(thumbnails.keys())
				.slice(0, 5)
				.map((path) => path.split('/').pop())
		);
	});

	// „Éï„Ç£„É´„Çø„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´ÁîªÂÉè„É™„Çπ„Éà„ÇíÂÜçË®àÁÆó
	$effect(() => {
		// „Éï„Ç£„É´„Çø„Çπ„Éà„Ç¢„ÅÆÁä∂ÊÖãÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
		filterStore.state.targetRating;
		filterStore.state.ratingComparison;
		filterStore.state.filenamePattern;
		filterStore.state.selectedTags;
		// „É¨„Éº„ÉÜ„Ç£„É≥„Ç∞Êõ¥Êñ∞„ÇÇÁõ£Ë¶ñ
		ratingUpdateTrigger;

		if (imageFiles.length > 0) {
			// „Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®„Åó„Å¶Ë°®Á§∫Áî®„ÅÆÁîªÂÉè„É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÔºàÂêåÊúüÂá¶ÁêÜ„ÅßÈ´òÈÄüÂåñÔºâ
			const filtered = filterStore.filterImages(
				imageFiles,
				ratings,
				tagAggregationService
			);
			filteredImageFiles = filtered;

			// Ë¶™„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´„Éï„Ç£„É´„ÇøÁµêÊûú„ÇíÈÄöÁü•
			if (onFilteredImagesUpdate) {
				onFilteredImagesUpdate(filtered.length, imageFiles.length);
			}

			console.log('„Éï„Ç£„É´„ÇøÈÅ©Áî®ÁµêÊûú:', filtered.length, '/', imageFiles.length);
		}
	});

	// Á¨¨1ÊÆµÈöéÔºöÁîªÂÉè„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÅÆÂèñÂæó„Å®„Ç∞„É™„ÉÉ„ÉâË°®Á§∫
	const loadImageFileList = async () => {
		if (loadingState.isProcessing) {
			console.log('„Çµ„É†„Éç„Ç§„É´Âá¶ÁêÜ‰∏≠„ÅÆ„Åü„ÇÅ„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô');
			return;
		}

		try {
			loadingState.isProcessing = true;
			loadingState.isLoading = true;
			loadingState.error = '';
			loadingState.loadedCount = 0;
			thumbnails.clear();

			// „Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆÁîªÂÉè„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
			imageFiles = await thumbnailService.getImageFiles(directoryPath);

			// ÂàùÊúüÁä∂ÊÖã„Åß„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®ÔºàÂêåÊúüÂá¶ÁêÜ„ÅÆ„ÅøÔºâ
			filteredImageFiles = imageFiles; // SD„Çø„Ç∞„Éï„Ç£„É´„Çø„ÅåË®≠ÂÆö„Åï„Çå„Çã„Åæ„Åß„ÅØÂÖ®ÁîªÂÉè„ÇíË°®Á§∫

			// Ë¶™„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´ÁîªÂÉè„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÈÄöÁü•
			if (onImageFilesLoaded) {
				onImageFilesLoaded(imageFiles);
			}

			// „Éï„Ç£„É´„ÇøÁµêÊûú„ÇÇÈÄöÁü•
			if (onFilteredImagesUpdate) {
				onFilteredImagesUpdate(filteredImageFiles.length, imageFiles.length);
			}

			if (imageFiles.length === 0) {
				loadingState.error = 'No image files found';
				loadingState.isLoading = false;
				loadingState.isProcessing = false;
				return;
			}

			loadingState.totalCount = imageFiles.length;
			loadingState.isLoading = false; // „Ç∞„É™„ÉÉ„Éâ„ÇíË°®Á§∫ÂèØËÉΩ„Å´„Åô„Çã

			console.log('ÁîªÂÉè„Éï„Ç°„Ç§„É´‰∏ÄË¶ßÂèñÂæóÂÆå‰∫Ü:', imageFiles.length, 'ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´');

			// Á¨¨2ÊÆµÈöéÔºö„Ç∑„É≥„Éó„É´„Ç≠„É•„Éº„Çí„ÉÜ„Çπ„Éà
			loadThumbnailsWithSimpleQueue();

			// Á¨¨3ÊÆµÈöéÔºöSD„Çø„Ç∞„Éá„Éº„Çø„ÇíÈõÜË®à
			loadTagData();
		} catch (err) {
			loadingState.error =
				err instanceof Error ? err.message : 'Failed to load image files';
			console.error('Failed to load image files:', err);
			loadingState.isLoading = false;
			loadingState.isProcessing = false;
		}
	};




	// „Ç∑„É≥„Éó„É´„Å™„Ç≠„É•„Éº„Éô„Éº„Çπ„ÅÆ„Çµ„É†„Éç„Ç§„É´ÁîüÊàêÔºà„Ç≠„É•„ÉºÂÅúÊ≠¢Ê©üËÉΩ‰ªò„ÅçÔºâ
	const loadThumbnailsWithSimpleQueue = async () => {
		console.log('=== loadThumbnailsWithSimpleQueue ÈñãÂßã ===');
		console.log('imageFiles:', imageFiles.length, 'ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´');

		try {
			console.log('„Ç∑„É≥„Éó„É´„Ç≠„É•„Éº„Éô„Éº„Çπ„ÅÆ„Çµ„É†„Éç„Ç§„É´ÁîüÊàêÈñãÂßã:', imageFiles.length, 'ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´');

			const resultThumbnails = await thumbnailService.loadThumbnailsWithSimpleQueue(
				imageFiles,
				(chunkResults) => {
					console.log('=== „Ç∑„É≥„Éó„É´„ÉÅ„É£„É≥„ÇØÂÆå‰∫Ü ===');
					console.log('„ÉÅ„É£„É≥„ÇØÁµêÊûúÂèó‰ø°:', chunkResults.size, 'ÂÄã„ÅÆ„Çµ„É†„Éç„Ç§„É´');

					// Êó¢Â≠ò„ÅÆthumbnails„Å´Êñ∞„Åó„ÅÑ„ÉÅ„É£„É≥„ÇØÁµêÊûú„Çí„Éû„Éº„Ç∏
					const newThumbnails = new Map(thumbnails);
					for (const [imagePath, thumbnailUrl] of chunkResults) {
						console.log(
							'„Çµ„É†„Éç„Ç§„É´ËøΩÂä†:',
							imagePath.split('/').pop(),
							thumbnailUrl.substring(0, 50) + '...'
						);
						newThumbnails.set(imagePath, thumbnailUrl);
					}

					thumbnails = newThumbnails;

					// „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞ÊôÇ„Å´„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞„ÇÇË™≠„ÅøËæº„Åø
					const chunkPaths = Array.from(chunkResults.keys());
					loadRatings(chunkPaths);
					ratingUpdateTrigger = Date.now();
					console.log('üîÑ „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞„ÄÅRatingË°®Á§∫Êõ¥Êñ∞„Éà„É™„Ç¨„Éº:', ratingUpdateTrigger);
					console.log('thumbnailsÊõ¥Êñ∞ („É™„Ç¢„É´„Çø„Ç§„É†):', thumbnails.size, 'ÂÄã„ÅÆ„Çµ„É†„Éç„Ç§„É´');
				},
				(loadedCount, totalCount) => {
					console.log('„Éó„É≠„Çª„ÇπÈÄöÁü•:', loadedCount, '/', totalCount);
					loadingState.loadedCount = loadedCount;
					loadingState.totalCount = totalCount;
				}
			);

			// ÊúÄÁµÇÁµêÊûú„Çí„Çª„ÉÉ„Éà
			thumbnails = resultThumbnails;
			
			// ÂÖ®„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞„ÇíË™≠„ÅøËæº„Åø
			await loadRatings(imageFiles);
			ratingUpdateTrigger = Date.now();

			console.log('„Ç∑„É≥„Éó„É´„Ç≠„É•„Éº„Éô„Éº„Çπ„ÅÆ„Çµ„É†„Éç„Ç§„É´ÁîüÊàêÂÆå‰∫Ü');
			loadingState.isProcessing = false;
		} catch (err) {
			console.error('„Ç∑„É≥„Éó„É´„Ç≠„É•„Éº„Éô„Éº„ÇπÂá¶ÁêÜ„Ç®„É©„Éº:', err);
			loadingState.isProcessing = false;
		}
	};


	// „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
	const cleanup = () => {
		// „Ç≠„É•„Éº„ÇíÂÅúÊ≠¢„Åó„Å¶„Åã„Çâ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
		thumbnailService.stopCurrentQueue();
		thumbnailService.cleanupThumbnails(thumbnails);
		thumbnails.clear();
	};

	// „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Éû„Ç¶„É≥„ÉàÊôÇ„Å® directoryPath Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
	let currentDirectory = '';

	// ÂàùÊúüÂåñÂá¶ÁêÜ
	$effect(() => {
		if (directoryPath && !currentDirectory) {
			currentDirectory = directoryPath;
			// „Åì„ÅÆ„Çµ„Éº„Éì„Çπ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çµ„Éº„Éì„Çπ„Å®„Åó„Å¶ÁôªÈå≤
			globalThumbnailService.setActiveService(thumbnailService);
			loadImageFileList();
		}

		// „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞„ÇíËøî„Åô
		return () => {
			cleanup();
		};
	});

	// directoryPath „ÅåÂ§âÊõ¥„Åï„Çå„ÅüÊôÇ„ÅÆÂá¶ÁêÜÔºàwatcher„Å®„Åó„Å¶Ôºâ
	$effect(() => {
		if (directoryPath && directoryPath !== currentDirectory && !loadingState.isProcessing) {
			console.log('„Éá„Ç£„É¨„ÇØ„Éà„É™Â§âÊõ¥Ê§úÂá∫:', currentDirectory, '->', directoryPath);
			currentDirectory = directoryPath;
			cleanup();
			loadImageFileList();
		}
	});

	// refreshTrigger „ÅåÂ§âÊõ¥„Åï„Çå„ÅüÊôÇ„ÅÆÂá¶ÁêÜÔºàÂâäÈô§Âæå„ÅÆÂÜçË™≠„ÅøËæº„ÅøÁî®Ôºâ
	$effect(() => {
		if (0 < refreshTrigger && refreshTrigger !== lastRefreshTrigger && !loadingState.isProcessing) {
			console.log('„É™„Éï„É¨„ÉÉ„Ç∑„É•„Éà„É™„Ç¨„ÉºÊ§úÂá∫:', refreshTrigger);
			lastRefreshTrigger = refreshTrigger;
			cleanup();
			loadImageFileList();
		}
	});

	const handleImageClick = (imagePath: string): void => {
		onImageSelect(imagePath);
	};

	const handleToggleSelection = (
		imagePath: string,
		shiftKey: boolean = false,
		metaKey: boolean = false
	): void => {
		if (onToggleSelection) {
			onToggleSelection(imagePath, shiftKey, metaKey);
		}
	};

	const handleRatingChange = async (imagePath: string, newRating: number): Promise<void> => {
		const success = await thumbnailService.updateImageRating(imagePath, newRating);
		if (success) {
			// „É≠„Éº„Ç´„É´ratings„Éû„ÉÉ„Éó„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
			const newRatings = new Map(ratings);
			newRatings.set(imagePath, newRating);
			ratings = newRatings;
			
			// ÊàêÂäüÊôÇ„Å´„É™„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊõ¥Êñ∞„Çí„Éà„É™„Ç¨„Éº
			ratingUpdateTrigger = Date.now();
			console.log('RatingÊõ¥Êñ∞ÊàêÂäü:', imagePath, newRating);
		} else {
			// „Ç®„É©„ÉºÊôÇ„ÅÆÂá¶ÁêÜ
			console.warn('RatingÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', imagePath);
		}
	};

	// SD„Çø„Ç∞„Éá„Éº„Çø„ÇíÈõÜË®à
	const loadTagData = async () => {
		try {
			console.log('SD„Çø„Ç∞„Éá„Éº„ÇøÈõÜË®àÈñãÂßã:', imageFiles.length, 'ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´');

			const tagData = await tagAggregationService.aggregateTagsFromFiles(imageFiles);

			console.log('SD„Çø„Ç∞„Éá„Éº„ÇøÈõÜË®àÂÆå‰∫Ü:', tagData.allTags.length, 'ÂÄã„ÅÆ„É¶„Éã„Éº„ÇØ„Çø„Ç∞');
			console.log('SD„Çø„Ç∞„Ç≠„É£„ÉÉ„Ç∑„É•Áµ±Ë®à:', tagAggregationService.getCacheStats());

			// Ë¶™„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´„Çø„Ç∞„Éá„Éº„Çø„ÇíÈÄöÁü•
			if (onTagDataLoaded) {
				onTagDataLoaded(tagData);
			}
		} catch (err) {
			console.error('SD„Çø„Ç∞„Éá„Éº„ÇøÈõÜË®à„Ç®„É©„Éº:', err);
		}
	};
</script>

<div class="h-full p-4">
	{#if loadingState.isLoading}
		<div class="flex h-full flex-col items-center justify-center">
			<div class="loading mb-4 loading-lg loading-spinner"></div>
			<p class="text-lg">Loading image file list...</p>
		</div>
	{:else if loadingState.error}
		<div class="flex h-full flex-col items-center justify-center">
			<div class="mb-4 text-6xl">‚ö†Ô∏è</div>
			<p class="mb-2 text-lg text-error">An error occurred</p>
			<p class="text-sm text-base-content/70">{loadingState.error}</p>
		</div>
	{:else if imageFiles.length === 0}
		<div class="flex h-full flex-col items-center justify-center">
			<div class="mb-4 text-6xl">üìÅ</div>
			<p class="text-lg">No image files found</p>
		</div>
	{:else}
		<div class="flex h-full flex-col">
			<!-- „Çµ„É†„Éç„Ç§„É´ÁîüÊàêÈÄ≤ÊçóË°®Á§∫ -->
			{#if loadingState.isProcessing && 0 < loadingState.totalCount}
				<div class="mb-4 flex items-center justify-between rounded-lg bg-base-200 p-3">
					<div class="flex items-center gap-3">
						<div class="loading loading-sm loading-spinner"></div>
						<span class="text-sm">Generating thumbnails...</span>
					</div>
					<div class="text-sm text-base-content/70">
						{loadingState.loadedCount} / {loadingState.totalCount} completed ({thumbnails.size} displayed)
					</div>
				</div>
			{/if}

			<!-- „Ç∞„É™„ÉÉ„ÉâË°®Á§∫ -->
			<div class="flex-1 overflow-auto">
				<div
					class="grid grid-cols-2 gap-3 p-1 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7"
				>
					{#each filteredImageFiles as imagePath (imagePath)}
						{@const isSelected = selectedImages.has(imagePath)}
						{@const rating = (() => {
							// ratingUpdateTrigger„ÇíÂèÇÁÖß„Åô„Çã„Åì„Å®„Åß„ÄÅRatingÊõ¥Êñ∞ÊôÇ„Å´„É™„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´ÂÜçË®àÁÆó„Åï„Çå„Çã
							ratingUpdateTrigger;
							return ratings.get(imagePath);
						})()}
						{@const thumbnailUrl = thumbnails.get(imagePath)}
						{@const isLoading = !thumbnails.has(imagePath)}
						<ImageThumbnail
							{imagePath}
							{thumbnailUrl}
							{rating}
							{isSelected}
							{isLoading}
							onImageClick={handleImageClick}
							onToggleSelection={handleToggleSelection}
							onRatingChange={handleRatingChange}
						/>
					{/each}
				</div>
			</div>
		</div>
	{/if}
</div>
