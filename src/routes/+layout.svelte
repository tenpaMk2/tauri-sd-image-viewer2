<script lang="ts">
	import { navigating } from '$app/state';
	import LoadingState from '$lib/components/ui/LoadingState.svelte';
	import Toast from '$lib/components/ui/Toast.svelte';
	import { navigateToGrid, navigateToViewer } from '$lib/services/app-navigation';
	import { dragAndDropService, type DragAndDropResult } from '$lib/services/drag-and-drop';
	import { initializeLogger } from '$lib/services/logger';
	import {} from 'svelte';
	import '../app.css';
	import type { LayoutProps } from './$types';

	// onMountではなく、スクリプト実行時すぐに初期化
	initializeLogger();

	const { children }: LayoutProps = $props();

	let unlistenDragDrop: (() => void) | null = null;

	$effect(() => {
		// ↓のログはロガーの初期化前に終わるのでログに出ない。
		console.log('💐Setting up drag & drop functionality');

		dragAndDropService
			.setupDragDropListener((result: DragAndDropResult) => {
				console.log('Drag & drop result:', result);

				switch (result.kind) {
					case 'file':
						navigateToViewer(result.path);
						break;
					case 'directory':
						navigateToGrid(result.path);
						break;
				}
			})
			.then((unlisten) => {
				unlistenDragDrop = unlisten;
			});

		// Cleanup function
		return () => {
			console.log('Cleaning up drag & drop listener');
			unlistenDragDrop?.();
		};
	});
</script>

<div class="h-screen min-h-screen bg-base-200 select-none">
	{@render children()}

	{#if navigating.complete}
		<!-- オーバーレイ背景 -->
		<div class="fixed inset-0 bg-base-200/70"></div>
		<!-- スピナー -->
		<div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
			<LoadingState status="loading" variant="big" />
		</div>
	{/if}
</div>

<Toast />
